<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />

  <title>HFT IPR CI/CD & Deployments</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script async src="https://production-assets.codepen.io/assets/embed/ei.js"></script>
<script defer src="main.js"></script></head>

<body>
  <div class="reveal">
    <div class="slides">
      <section data-background-image="https://media.giphy.com/media/H4buZ6PLgwsKjA9hlO/giphy.gif">
        <h1 class="title">IPR</h1>
        <h3 class="title">CI/CD & Deployments</h3>
      </section>

      <!-- Begriffe -->
      <section>
        <section data-auto-animate data-background-size="cover"
          data-background-image="https://media.giphy.com/media/cItQNjtLFq4fti3hzJ/giphy.gif">
          <h3 class="title">Begriffe</h3>
        </section>
        <section data-auto-animate>
          <h3>continuous integration (CI)</h3>
          <p>Unter kontinuierlicher Integration (Continuous Integration, CI) versteht man die Automatisierung
            der Integration von Codeänderungen mehrerer Beteiligter in ein einziges Softwareprojekt. Automatisierte
            Tools werden
            eingesetzt, um die Korrektheit des neuen Codes vor der Integration zu überprüfen. Ein Versionskontrollsystem
            für den Quellcode ist das Herzstück des CI-Prozesses.
          </p>
        </section>
        <section data-auto-animate>
          <h3>continuous integration Anbieter</h3>
          <ul>
            <li>Azure Pipelines</li>
            <li>Bitbucket</li>
            <li>GitLab</li>
            <li>GitHub Actions</li>
            <li>CircleCI</li>
            <li>TravisCI</li>
            <li>Concourse (self hosted)</li>
          </ul>
        </section>
        <section data-auto-animate>
          <h3>Trunk Based Development</h3>
          <ul>
            <li>Single Source of Truth</li>
            <li>Kurzlebige branches</li>
            <li>Einfache Code Integration</li>
            <li>Feature Flags</li>
          </ul>
        </section>
        <section data-auto-animate>
          <img src="https://about.gitlab.com/images/gitlab-flow/gitlab-flow.svg" alt="">
        </section>
        <section data-auto-animate>
          <h3>Gitflow</h3>
          <ul>
            <li>Eigene Branches für Hotfix, Releases, Features</li>
            <li>Branches sind eher länger offen</li>
            <li>Workflow ist eher strikt</li>
            <li>Passt bei Open Source Projekten tendenziell besser</li>
          </ul>
        </section>
        <section data-auto-animate>
          <img
            src="https://wac-cdn.atlassian.com/dam/jcr:a13c18d6-94f3-4fc4-84fb-2b8f1b2fd339/01%20How%20it%20works.svg?cdnVersion=314"
            alt="">
        </section>
        <section data-auto-animate>
          <img
            src="https://wac-cdn.atlassian.com/dam/jcr:34c86360-8dea-4be4-92f7-6597d4d5bfae/02%20Feature%20branches.svg?cdnVersion=314"
            alt="">
        </section>
        <section data-auto-animate>
          <img
            src="https://wac-cdn.atlassian.com/dam/jcr:cc0b526e-adb7-4d45-874e-9bcea9898b4a/04%20Hotfix%20branches.svg?cdnVersion=314"
            alt="">
        </section>
        <section data-auto-animate>
          <h3>continuous delivery (cd)</h3>
          <p>Unter kontinuierlicher Bereitstellung (Continuous Delivery, CD) versteht man die Automatisierung
            eines Release Prozesses. Der maximale Aufwand soll hier bei einem Button Klick liegen. In der Theorie kann
            monatlich, wöchentlich oder sogar stündlich eine neue Software Version zur Verfügung gestellt werden. Das
            Ziel ist jedoch meistens so früh wie möglich kleine Chargen freizugeben, damit Probleme leichter zu beheben
            sind.
          </p>
        </section>
        <section data-auto-animate>
          <img
            src="https://wac-cdn.atlassian.com/dam/jcr:b2a6d1a7-1a60-4c77-aa30-f3eb675d6ad6/ci%20cd%20asset%20updates%20.007.png?cdnVersion=314"
            alt="">
        </section>
        <section data-auto-animate>
          <h3>Deployment</h3>
          <p>Unter einem Deployment versteht man den tatsächlichen Release einer Software völlig losgelöst von
            Code Versionierung oder Integrationssystemen. Es geht hier ausschließlich um das einmalige Ausliefern. Das
            kann ein brennen auf eine CD oder das hochladen einer Binary für einen Application server sein.
          </p>
        </section>
        <section data-auto-animate>
          <h3>Deployment Strategien</h3>
          <ul>
            <li><strong>Recreate</strong>: Version A wird gestoppt, danach wird Version B gestartet</li>
            <li><strong>Rolling</strong> Version B ersetzt nach und nach Version A</li>
            <li><strong>Blue-Green</strong>: Version B wird parallel gestartet. Dann wird der Traffik von A auf B
              umgeleitet.</li>
          </ul>
        </section>
        <section data-auto-animate>
          <h3>Deployment Strategien</h3>
          <ul>
            <li><strong>Canary</strong>: Version B wird nur an bestimmte Kunden ausgeliefert und danach an alle.</li>
            <li><strong>A/B</strong>: Version B wird wird nur an bestimmte Kunden ausgeliefert unter Berücksichtigung
              bestimmer Kriterien
            </li>
          </ul>
        </section>
        <section data-auto-animate>
          <h3>Komponenten</h3>
          <img src="https://d3eeke16mv0lt7.cloudfront.net/sites/default/files/screen_shot_2017-06-13_at_21.36.08_0.png"
            alt="" />

        </section>
        <section>
          <h3><a href="https://www.docker.com/resources/what-container/" target="_blank">Was ist Docker?</a></h3>
        </section>
      </section>

      <!-- Docker -->
      <section>
        <section data-auto-animate data-background-size="cover"
          data-background-image="https://media.giphy.com/media/rCQTCy4rvuxR6/giphy.gif">
          <h3 class="title">Docker</h3>
        </section>
        <section data-auto-animate>
          <h3 class="title">Lokales Image erstellen</h3>
          <pre><code class="bash" data-trim data-noescape data-line-numbers><script type="text/template">
            docker build .
          </script></code></pre>
          <pre><code class="bash" data-trim data-noescape data-line-numbers><script type="text/template">
            docker build -f infrastructure/Dockerfile .
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3 class="title">Image Tags</h3>
          <pre><code class="bash" data-trim data-noescape data-line-numbers><script type="text/template">
            docker build -f infrastructure/Dockerfile -t maciossek/crap-stories-react .
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3 class="title">Image Testen</h3>
          <pre><code class="bash" data-trim data-noescape data-line-numbers><script type="text/template">
            docker run -p 3000:80 maciossek/crap-stories-react
          </script></code></pre>
        </section>
      </section>

      <!-- GitHub Actions Backend -->
      <section>
        <section data-auto-animate data-background-size="cover"
          data-background-image="https://media.giphy.com/media/Oj5w7lOaR5ieNpuBhn/giphy.gif">
          <h3 class="title">Github actions backend</h3>
        </section>
        <section>
          <h3>GitHub Actions Backend</h3>
          <ul>
            <li>
              codecov.yml
            </li>
            <li>
              Dockerfile
            </li>
          </ul>
        </section>
        <section data-auto-animate>
          <h3>package.json</h3>
          <pre><code class="json" data-trim data-noescape data-line-numbers><script type="text/template">
            {
              "jest": {
                "coverageThreshold": {
                  "global": {
                    "branches": 75,
                    "functions": 75,
                    "lines": 75,
                    "statements": 75
                  }
                },
                "coverageReporters": [
                  "cobertura",
                  "json",
                  "lcov",
                  "text"
                ]
              }
            }           
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>codecov.yml</h3>
          <pre><code class="yaml" data-trim data-noescape data-line-numbers><script type="text/template">
            coverage:
              precision: 2
              round: down
              range: "75...100"
              status:
                patch:
                  default:
                    target: 0%
                project:
                  default:
                    target: 75%
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>Dockerfile</h3>
          <pre><code class="Dockerfile" data-trim data-noescape data-line-numbers><script type="text/template">
            FROM nginx:stable-alpine
            LABEL maintainer "mathias.maciossek@gmail.com"
            LABEL org.opencontainers.image.source="https://github.com/maciossek/crap-stories-node"

            WORKDIR /usr/app

            ENV NODE_ENV=development
            ENV PORT=3001
            ENV LOG_LEVEL=debug
            ENV CORS_URLS=http://example.com
            ENV DB_HOST=postgresql://hft:hft@localhost:5432/hft
            ENV PGSSLMODE=disable
            ENV JWKS_URI=https://maciossek-hft.eu.auth0.com/.well-known/jwks.json


            RUN apk add --update nodejs npm
            RUN npm install -f @swc/core-linux-arm64-musl

            COPY . /usr/app

            ENTRYPOINT ["npm", "run", "start:seed:migrate"]           
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>.github/workflows/deploy.yml</h3>
          <pre><code class="yaml" data-trim data-noescape data-line-numbers><script type="text/template">
            name: Deploy

            on:
              push:
                branches: [main, "feature/*"]
              pull_request:
                branches: [main, "feature/*"]
            
            jobs:
              test-and-build:
                runs-on: ubuntu-latest
            
                strategy:
                  matrix:
                    node-version: [19]
            
                services:
                  # Label used to access the service container
                  postgres:
                    # Docker Hub image
                    image: postgres:15
                    # Provide the password for postgres
                    env:
                      POSTGRES_PASSWORD: hft
                      POSTGRES_USER: hft
                      PGTZ: UTC
                    # Set health checks to wait until postgres has started
                    options: >-
                      --health-cmd pg_isready
                      --health-interval 10s
                      --health-timeout 5s
                      --health-retries 5
                    ports:
                      # Maps tcp port 5432 on service container to the host
                      - 5432:5432
            
                steps:
                  # Downloads a copy of the code in your repository before running CI tests
                  - name: Check out repository code
                    uses: actions/checkout@v2
                  - name: Use Node.js ${{ matrix.node-version }}
                    uses: actions/setup-node@v1
                    with:
                      node-version: ${{ matrix.node-version }}
            
                  # Performs a clean installation of all dependencies in the `package.json` file
                  # For more information, see https://docs.npmjs.com/cli/ci.html
                  - name: Install dependencies
                    run: npm install
                  - name: Run Database migrations
                    run: npm run migrate
                    env:
                      DB_HOST: postgresql://hft:hft@localhost:5432/hft
                      JWKS_URI: none-of-your-business
                  - name: Run Tests
                    run: npm run test:ci
                    env:
                      DB_HOST: postgresql://hft:hft@localhost:5432/hft
                      JWKS_URI: none-of-your-business
                  - name: Run Build
                    run: npm run build
                  - uses: codecov/codecov-action@v1
                    with:
                      token: ${{ secrets.CODECOV_TOKEN }}
                      file: ./coverage/cobertura-coverage.xml
                      flags: unittests # optional
                      name: codecov-umbrella # optional
                  - name: 🐳 Login to Docker Hub
                    uses: docker/login-action@v2
                    with:
                      registry: ghcr.io
                      username: ${{ github.actor }}
                      password: ${{ secrets.GITHUB_TOKEN }}
                  - name: 🐳 Setup buildx
                    uses: docker/setup-buildx-action@v2
                  - name: 🐳 Build and Push Docker Image
                    uses: docker/build-push-action@v3
                    with:
                      context: .
                      file: ./infrastructure/Dockerfile
                      push: true
                      tags: |
                        ghcr.io/${{ github.repository }}:latest            
          </script></code></pre>
        </section>
      </section>


      <!-- GitHub Actions Frontend -->
      <section>
        <section data-auto-animate data-background-size="cover"
          data-background-image="https://media.giphy.com/media/Cu87j5pPIL1hS/giphy.gif">
          <h3 class="title">GitHub Actions Frontend</h3>
        </section>
        <section data-auto-animate data-background-color="hotpink">
          <h3>🤨</h3>
          <ul>
            <li class="fragment">Wann werden die Umgebungsvariablen in die React App gebacken...?</li>
          </ul>
        </section>
        <section>
          <h3>GitHub Actions Frontend</h3>
          <ul>
            <li>
              nginx.conf
            </li>
            <li>
              Dockerfile
            </li>
            <li>
              codecov.yml
            </li>
            <li>
              <a href="https://www.npmjs.com/package/react-inject-env" target="_blank">react-inject-env</a>
            </li>
          </ul>
        </section>
        <section data-auto-animate>
          <h3>package.json</h3>
          <pre><code class="json" data-trim data-noescape data-line-numbers><script type="text/template">
            {
              "jest": {
                "coverageThreshold": {
                  "global": {
                    "branches": 75,
                    "functions": 75,
                    "lines": 75,
                    "statements": 75
                  }
                },
                "coverageReporters": [
                  "cobertura",
                  "json",
                  "lcov",
                  "text"
                ]
              }
            }           
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>package.json</h3>
          <pre><code class="Dockerfile" data-trim data-noescape data-line-numbers><script type="text/template">
            FROM nginx:stable-alpine
            LABEL maintainer "mathias.maciossek@gmail.com"
            LABEL org.opencontainers.image.source="https://github.com/maciossek/crap-stories-react"
            RUN apk add --update nodejs npm
            RUN npm install -g react-inject-env
            RUN rm /etc/nginx/conf.d/default.conf

            COPY ./infrastructure/nginx.conf /etc/nginx/conf.d/
            COPY ./build /usr/share/nginx/html
            ENTRYPOINT sh -c "npx react-inject-env set -d /usr/share/nginx/html/ && nginx -g 'daemon off;'"         
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>nginx.conf</h3>
          <pre><code class="conf" data-trim data-noescape data-line-numbers><script type="text/template">
            server {
              listen 80;
              sendfile on;
              default_type application/octet-stream;
              gzip on;
              gzip_http_version 1.1;
              gzip_disable “MSIE [1–6]\.”;
              gzip_min_length 256;
              gzip_vary on;
              gzip_proxied expired no-cache no-store private auth;
              gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;
              gzip_comp_level 9;
              root /usr/share/nginx/html;
              location / {
                  try_files $uri $uri/ /index.html =404;
                  proxy_redirect     off;
                  proxy_set_header   X-Real-IP $remote_addr;
                  proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header   X-Forwarded-Host $server_name;
              }
          }          
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>codecov.yml</h3>
          <pre><code class="yaml" data-trim data-noescape data-line-numbers><script type="text/template">
            coverage:
              precision: 2
              round: down
              range: "75...100"
              status:
                patch:
                  default:
                    target: 0%
                project:
                  default:
                    target: 75%
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>.github/workflows/deploy.yml</h3>
          <small>Frontend</small>
          <pre><code class="yaml" data-trim data-noescape data-line-numbers><script type="text/template">
            name: Deploy

            on:
              push:
                branches: [main, "feature/*"]
              pull_request:
                branches: [main, "feature/*"]

            jobs:
              test-and-build:
                name: Test and Build
                runs-on: ubuntu-latest

                strategy:
                  matrix:
                    node-version: [19]

                steps:
                  - uses: actions/checkout@v3
                  - name: Use Node.js ${{ matrix.node-version }}
                    uses: actions/setup-node@v3
                    with:
                      node-version: ${{ matrix.node-version }}
                  - run: yarn install
                  - run: yarn run test:ci
                  - run: yarn run build
                    env:
                      REACT_APP_NODE_ENV: production
                      REACT_APP_COMMIT_HASH: ${{ github.sha }}
                  - uses: codecov/codecov-action@v1
                    with:
                      token: ${{ secrets.CODECOV_TOKEN }}
                      file: ./coverage/cobertura-coverage.xml
                      flags: unittests # optional
                      name: codecov-umbrella # optional
                  - name: 🐳 Login to Docker Hub
                    uses: docker/login-action@v2
                    with:
                      registry: ghcr.io
                      username: ${{ github.actor }}
                      password: ${{ secrets.GITHUB_TOKEN }}
                  - name: 🐳 Setup buildx
                    uses: docker/setup-buildx-action@v2
                  - name: 🐳 Build and Push Docker Image
                    uses: docker/build-push-action@v3
                    with:
                      context: .
                      file: ./infrastructure/Dockerfile
                      push: true
                      tags: |
                        ghcr.io/${{ github.repository }}:latest

          </script></code></pre>
        </section>
      </section>

      <!-- Docker Compose -->
      <section>
        <section data-auto-animate data-background-size="cover"
          data-background-image="https://media.giphy.com/media/5YiNunQI0Wg9Mpc6Ts/giphy.gif">
          <h3 class="title">Docker Compose</h3>
        </section>
        <section>
          <h3>Docker Compose</h3>
          <pre><code class="yml" data-trim data-noescape data-line-numbers><script type="text/template">
            version: "3"
            services:
              postgres-hft:
                container_name: crap-stories-postgres
                image: postgres:14.2
                ports:
                  - 5433:5432
                environment:
                  - POSTGRES_PASSWORD=hft
                  - POSTGRES_USER=hft
                restart: always
              backend:
                container_name: crap-stories-node
                image: maciossek/crap-stories-node:latest
                ports:
                  - 3001:3001
                environment:
                  - DB_HOST=postgresql://hft:hft@postgres-hft:5432/hft
                restart: always
                links:
                  - postgres-hft
                depends_on:
                  - postgres-hft
              frontend:
                container_name: crap-stories-react
                image: maciossek/crap-stories-react:latest
                ports:
                  - 3000:80
                restart: always

          </script></code></pre>
        </section>
      </section>

      <!-- Heroku -->
      <section>
        <section data-auto-animate data-background-size="cover"
          data-background-image="https://media.giphy.com/media/5YiNunQI0Wg9Mpc6Ts/giphy.gif">
          <h3 class="title">Source Code based App Hosting</h3>
          <small class="white">Mit Heroku ❤️</small>
        </section>
        <section>
          <h3>Alternativen</h3>
          <ul>
            <li><a href="https://pages.cloudflare.com/">Cloudflare Pages</a></li>
            <li><a href="https://cloud.google.com/appengine/">Google App Engine</a></li>
            <li><a href="https://aws.amazon.com/elasticbeanstalk/">AWS Elastic Beanstalk</a></li>
            <li>uvm.</li>
          </ul>
        </section>
        <section data-auto-animate>
          <h3>Frontend Procfile</h3>
          <pre><code class="bash" data-trim data-noescape data-line-numbers><script type="text/template">
            web: bin/boot
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>Frontend static.json</h3>
          <pre><code class="json" data-trim data-noescape data-line-numbers><script type="text/template">
            {
              "root": "build/",
              "routes": {
                "/**": "index.html"
              },
              "https_only": true,
              "headers": {
                "/**": {
                  "Strict-Transport-Security": "max-age=31557600"
                }
              }
            }
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>Backend Procfile</h3>
          <pre><code class="bash" data-trim data-noescape data-line-numbers><script type="text/template">
            web: node dist/index.js
          </script></code></pre>
        </section>
        <section data-auto-animate>
          <h3>Backend ENV Vars</h3>
          <pre><code class="bash" data-trim data-noescape data-line-numbers><script type="text/template">
            PGSSLMODE=no-verify
            CORS_URLS=frontend-url
          </script></code></pre>
        </section>
      </section>

      <section>
        <h3>Links</h3>
        <ul>

          <li>
            <a href="https://github.com/maciossek/crap-stories-node/tree/feature/cicd">Backend Repo</a>
          </li>
          <li>
            <a href="https://github.com/maciossek/crap-stories-react/tree/feature/cicd">Frontend Repo</a>
          </li>
          <li>
            <a href="https://github.com/features/actions">GitHub Actions</a>
          </li>
          <li>
            <a href="https://vercel.com/">Vercel</a>
          </li>
          <li>
            <a href="https://www.heroku.com/">Heroku</a>
          </li>
        </ul>
      </section>
    </div>
  </div>
</body>

</html>
